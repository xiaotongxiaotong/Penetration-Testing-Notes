1.SSH端口转发基础概念
本地端口转发（-L）
将本地端口流量转发到远程服务器
格式：ssh -L [本地IP：]本地端口：目标主机：目标端口 @跳板机用户IP
示例：`ssh -L 8080:192.168.1.100:80 user@jumpbox.com`
远程端口转发（-R）
将远程服务器端口流量转发到本地
格式：ssh -R [远程IP:]远程端口:本地主机:本地端口 跳板机用户@跳板机IP
示例：ssh -R 2222:localhost:22 user@remoteserver.com
动态端口转发（-D）
建立SOCKS代理服务器
格式：ssh -D [本地IP:]本地端口 跳板机用户@跳板机IP
示例：ssh -D 1080 user@jumpbox.com
## SSH（secure shell 隧道）三种转发模式
##### 本地端口转发（-L）从外面进去通过地道
1.1首先在Kali上创建配置文件
mkdir -p ~/.ssh
cat > ~/.ssh/config << 'EOF'
Host 192.168.202.183
    HostKeyAlgorithms +ssh-rsa
    PubkeyAcceptedKeyTypes +ssh-rsa
EOF
chmod 600 ~/.ssh/config
1.2 清理可能占用的端口
sudo fuser -k 8080/tcp 2>/dev/null
sudo fuser -k 8081/tcp 2>/dev/null
1.3尝试进行SSH连接
ssh msfadmin@192.168.202.183
输入用户名和密码msfadmin
建立隧道
ssh -L 8080:127.0.0.1:80 msfadmin@192.168.202.183（8080端口为隧道端口）
再另一个终端测试curl http://127.0.0.1:8080 | head -5如果有HTML文件打开则实验完成
##### 远程端口转发（-R）从里面到外面
在我的主机作为公网服务器，在metasploitable2上执行远程转发
ssh -R 2222:127.0.0.1:22 user@主机IP
ssh msfadmin@192.168.202.183(登入metasploitable2)
在metasploitable2上执行-R转发ssh -R 9999:127.0.0.1:80 kali@KaliIP
##### 动态端口转发（-D）-SOCKS代理（挖了一个万能通道）
1.首先建立SOCKS代理隧道
ssh -D 1080 msfadmin@192.168.202.183
2.测试SOCKS代理
使用curl测试
curl --socks5 127.0.0.1:1080 http://192.168.202.183 如果有HTML文件打开则测试完成

因为暂时还不能利用工具下载chisel，所以这里可以使用socat工具
在Kali安装下socat
sudo apt update
sudo apt install socat -y
在metasploitable2安装socat
ssh msfadmin@192.168.202.183 "sudo apt-get update && sudo apt-get install socat -y"
接下来进行本地端口转发
在metasploitable2启动socat服务端
ssh msfadmin@192.168.202.183 "socat TCP-LISTEN:9999,fork,reuseaddr EXEC:'bash -c \"while read line; do echo \$line; done\"'"
在Kali建立隧道
socat TCP-LISTEN:8080,fork,reuseaddr TCP:192.168.202.183:80
进行测试
curl http://127.0.0.1:8080

![[Pasted image 20251213154050.png]]



